
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver servo_driver = Adafruit_PWMServoDriver();


// Declare each servo
{% for tabName in list_of_names %}int {{tabName}};
{% endfor %}
// Array of servos, useful to iterate over
int SERVO_ARR[] = { {% for tabName in list_of_names %}{{tabName}}, {% endfor %}};

// Calculate number of servos
byte NUM_SERVOS = sizeof(SERVO_ARR) / sizeof(int);

// Time 'delay' between each servo position update
const unsigned long INTERVAL = {{interval}};


// Initialize servo position (value) arrays for each servo
// These are the recorded routines
{% for tabName, array in zip(list_of_names,tweenerArrays) %}
const byte {{tabName}}_arr[]PROGMEM = 
{
{{array}}
};
{% endfor %}
// Calculate length of value array (how long the routine is)
const unsigned int ARRAY_LENGTH = sizeof({{list_of_names[0]}}_arr) / sizeof(byte);

// Array of position(value) arrays, useful to iterate over 
const byte* VALUES_ARRAY[] = { {% for tabName in list_of_names %}{{tabName}}_arr, {% endfor %}};

{% if button != 'None' %}
// Button to start routine
const byte BUTTON_PIN = {{button}};
{% endif %}

//================================
const int SERVOMIN = 150;
const int SERVOMAX = 585;

//================================
void routine(int arr_of_servos[], byte num_of_servos, const byte* arr_of_valueArrays[], byte interval, unsigned int length)
{
  /*
    Updates positions of all servos concurrently for entirety of the
    routine length (all values in value arrays
  */

  unsigned long start_millis = millis();
  boolean routine_running = true;
  unsigned long pos = 0;
  unsigned long end_millis;
  
  Serial.println(F("Inside the routine"));
  
  while (routine_running)
  {
    // These need to be long type for arithmetic and comparison to work properly
    unsigned long elapsed_time = (millis() - start_millis);
    unsigned long compare_to = (interval * pos);
    
    if (elapsed_time > compare_to)
    {
      for (byte i=0; i<num_of_servos; i++)
      {
        byte temp_byte = pgm_read_byte(&arr_of_valueArrays[i][pos]);
        int value = map(temp_byte, 0, 179, SERVOMIN, SERVOMAX);
        
        servo_driver.setPin(i, value);
      }
      pos++;
    }
  
    if (pos >= length)
    {
      routine_running = false;
      end_millis = millis();
    }
  }

  // Add delay at end of routine
  unsigned long start_delay = millis();
  while ((millis() - start_delay) < 3000)
  {
  }

  // Reset servos to initial position
  for (byte i=0; i<num_of_servos; i++)
  {
    byte temp_byte = pgm_read_byte(&arr_of_valueArrays[i][0]);
    int value = map(temp_byte, 0, 179, SERVOMIN, SERVOMAX);
    servo_driver.setPin(i, value);
  }

  Serial.println(F("Routine has ended"));
  float total_secs = (end_millis - start_millis) / 1000;
  Serial.print(F("Total seconds: "));
  Serial.println(total_secs);

}

//================================

void setup() {

  Serial.begin(9600);
  Serial.println(F("Hello from the Microcontroller i2c template"));
  Serial.print("array length: ");
  Serial.println(ARRAY_LENGTH);

{% if button != 'None' %}
  pinMode(BUTTON_PIN, INPUT_PULLUP); {% endif %}

  servo_driver.begin();
  servo_driver.setPWMFreq(50);

  for (byte i=0; i<NUM_SERVOS; i++)
  // Set all servos to starting position
  {
    byte temp_byte = pgm_read_byte(&VALUES_ARRAY[i][0]);
    int value = map(temp_byte, 0, 179, SERVOMIN, SERVOMAX);
    servo_driver.setPin(i, value);
  }

  long now = millis();  // Add delay before loop starts
  while ((millis() - now) < 2000)
  {
  }

  Serial.println(F("Now entering main loop..."));
}


void loop() {% if button != 'None' %}
{
  // Button press starts servo routine
  if ((digitalRead(BUTTON_PIN) == LOW))
  {
    long now = millis();
    if ((millis() - now) < 50){}  // 50ms delay to debounce
    if ((digitalRead(BUTTON_PIN) == LOW))
    {
      Serial.println(F("Routine Started"));
      routine(SERVO_ARR, NUM_SERVOS, VALUES_ARRAY, INTERVAL, ARRAY_LENGTH);
      Serial.println(F("Exiting routine"));
    }
  }
{% else %}{
  // Do something with routine function:
    // routine(SERVO_ARR, NUM_SERVOS, VALUES_ARRAY, INTERVAL, ARRAY_LENGTH);
{% endif %}
}


